<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InboxService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Docs Core</a> &gt; <a href="index.source.html" class="el_package">com.sismics.docs.core.service</a> &gt; <span class="el_source">InboxService.java</span></div><h1>InboxService.java</h1><pre class="source lang-java linenums">package com.sismics.docs.core.service;

import com.google.common.collect.Lists;
import com.google.common.collect.Sets;
import com.google.common.util.concurrent.AbstractScheduledService;
import com.sismics.docs.core.constant.ConfigType;
import com.sismics.docs.core.dao.TagDao;
import com.sismics.docs.core.dao.criteria.TagCriteria;
import com.sismics.docs.core.dao.dto.TagDto;
import com.sismics.docs.core.event.DocumentCreatedAsyncEvent;
import com.sismics.docs.core.model.jpa.Config;
import com.sismics.docs.core.model.jpa.Document;
import com.sismics.docs.core.model.jpa.Tag;
import com.sismics.docs.core.util.ConfigUtil;
import com.sismics.docs.core.util.DocumentUtil;
import com.sismics.docs.core.util.FileUtil;
import com.sismics.docs.core.util.TransactionUtil;
import com.sismics.docs.core.util.jpa.SortCriteria;
import com.sismics.util.EmailUtil;
import com.sismics.util.context.ThreadLocalContext;
import org.apache.commons.lang.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.mail.*;
import javax.mail.search.FlagTerm;
import java.util.*;
import java.util.concurrent.TimeUnit;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * Inbox scanning service.
 *
 * @author bgamard
 */
public class InboxService extends AbstractScheduledService {
    /**
     * Logger.
     */
<span class="fc" id="L41">    private static final Logger log = LoggerFactory.getLogger(InboxService.class);</span>

    /**
     * Last synchronization data.
     */
    private Date lastSyncDate;
<span class="fc" id="L47">    private int lastSyncMessageCount = 0;</span>
    private String lastSyncError;

<span class="fc" id="L50">    public InboxService() {</span>
<span class="fc" id="L51">    }</span>

    @Override
    protected void startUp() {
<span class="fc" id="L55">        log.info(&quot;Inbox service starting up&quot;);</span>
<span class="fc" id="L56">    }</span>

    @Override
    protected void shutDown() {
<span class="nc" id="L60">        log.info(&quot;Inbox service shutting down&quot;);</span>
<span class="nc" id="L61">    }</span>
    
    @Override
    protected void runOneIteration() {
        try {
<span class="fc" id="L66">            syncInbox();</span>
<span class="nc" id="L67">        } catch (Throwable e) {</span>
<span class="nc" id="L68">            log.error(&quot;Exception during inbox synching&quot;, e);</span>
<span class="fc" id="L69">        }</span>
<span class="fc" id="L70">    }</span>

    /**
     * Synchronize the inbox.
     */
    public void syncInbox() {
<span class="fc" id="L76">        TransactionUtil.handle(() -&gt; {</span>
<span class="fc" id="L77">            Boolean enabled = ConfigUtil.getConfigBooleanValue(ConfigType.INBOX_ENABLED);</span>
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">            if (!enabled) {</span>
<span class="fc" id="L79">                return;</span>
            }

<span class="nc" id="L82">            log.info(&quot;Synchronizing IMAP inbox...&quot;);</span>
<span class="nc" id="L83">            Folder inbox = null;</span>
<span class="nc" id="L84">            lastSyncError = null;</span>
<span class="nc" id="L85">            lastSyncDate = new Date();</span>
<span class="nc" id="L86">            lastSyncMessageCount = 0;</span>
            try {
<span class="nc" id="L88">                Map&lt;String, String&gt; tagsNameToId = getAllTags();</span>

<span class="nc" id="L90">                inbox = openInbox();</span>
<span class="nc" id="L91">                Message[] messages = inbox.search(new FlagTerm(new Flags(Flags.Flag.SEEN), false));</span>
<span class="nc" id="L92">                log.info(messages.length + &quot; messages found&quot;);</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">                for (Message message : messages) {</span>
<span class="nc" id="L94">                    importMessage(message, tagsNameToId);</span>
<span class="nc" id="L95">                    lastSyncMessageCount++;</span>
                }
<span class="nc" id="L97">            } catch (FolderClosedException e) {</span>
                // Ignore this, we will just continue importing on the next cycle
<span class="nc" id="L99">            } catch (Exception e) {</span>
<span class="nc" id="L100">                log.error(&quot;Error syncing the inbox&quot;, e);</span>
<span class="nc" id="L101">                lastSyncError = e.getMessage();</span>
            } finally {
                try {
<span class="nc bnc" id="L104" title="All 2 branches missed.">                    if (inbox != null) {</span>
                        // The parameter controls if the messages flagged to be deleted, should actually get deleted.
<span class="nc" id="L106">                        inbox.close(ConfigUtil.getConfigBooleanValue(ConfigType.INBOX_DELETE_IMPORTED));</span>
<span class="nc" id="L107">                        inbox.getStore().close();</span>
                    }
<span class="nc" id="L109">                } catch (Exception e) {</span>
                    // NOP
<span class="nc" id="L111">                }</span>
            }
<span class="nc" id="L113">        });</span>
<span class="fc" id="L114">    }</span>

    /**
     * Test the inbox configuration.
     *
     * @return Number of messages currently in the remote inbox
     */
    public int testInbox() {
<span class="nc" id="L122">        Boolean enabled = ConfigUtil.getConfigBooleanValue(ConfigType.INBOX_ENABLED);</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (!enabled) {</span>
<span class="nc" id="L124">            return -1;</span>
        }

<span class="nc" id="L127">        Folder inbox = null;</span>
        try {
<span class="nc" id="L129">            inbox = openInbox();</span>
<span class="nc" id="L130">            return inbox.search(new FlagTerm(new Flags(Flags.Flag.SEEN), false)).length;</span>
<span class="nc" id="L131">        } catch (Exception e) {</span>
<span class="nc" id="L132">            log.error(&quot;Error testing inbox&quot;, e);</span>
<span class="nc" id="L133">            return -1;</span>
        } finally {
            try {
<span class="nc bnc" id="L136" title="All 2 branches missed.">                if (inbox != null) {</span>
<span class="nc" id="L137">                    inbox.close(false);</span>
<span class="nc" id="L138">                    inbox.getStore().close();</span>
                }
<span class="nc" id="L140">            } catch (Exception e) {</span>
                // NOP
<span class="nc" id="L142">            }</span>
        }
    }

    @Override
    protected Scheduler scheduler() {
<span class="fc" id="L148">        return Scheduler.newFixedDelaySchedule(0, 1, TimeUnit.MINUTES);</span>
    }

    /**
     * Open the remote inbox.
     *
     * @return Opened inbox folder
     * @throws Exception e
     */
    private Folder openInbox() throws Exception {
<span class="nc" id="L158">        Properties properties = new Properties();</span>
<span class="nc" id="L159">        String port = ConfigUtil.getConfigStringValue(ConfigType.INBOX_PORT);</span>
<span class="nc" id="L160">        properties.put(&quot;mail.imap.host&quot;, ConfigUtil.getConfigStringValue(ConfigType.INBOX_HOSTNAME));</span>
<span class="nc" id="L161">        properties.put(&quot;mail.imap.port&quot;, port);</span>
<span class="nc" id="L162">        boolean isSsl = &quot;993&quot;.equals(port);</span>
<span class="nc" id="L163">        properties.put(&quot;mail.imap.ssl.enable&quot;, String.valueOf(isSsl));</span>
<span class="nc" id="L164">        properties.setProperty(&quot;mail.imap.socketFactory.class&quot;,</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">                isSsl ? &quot;javax.net.ssl.SSLSocketFactory&quot; : &quot;javax.net.DefaultSocketFactory&quot;);</span>
<span class="nc" id="L166">        properties.setProperty(&quot;mail.imap.socketFactory.fallback&quot;, &quot;true&quot;);</span>
<span class="nc" id="L167">        properties.setProperty(&quot;mail.imap.socketFactory.port&quot;, port);</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">        if (isSsl) {</span>
<span class="nc" id="L169">            properties.put(&quot;mail.imaps.connectiontimeout&quot;, 30000);</span>
<span class="nc" id="L170">            properties.put(&quot;mail.imaps.timeout&quot;, 30000);</span>
<span class="nc" id="L171">            properties.put(&quot;mail.imaps.writetimeout&quot;, 30000);</span>
        } else {
<span class="nc" id="L173">            properties.put(&quot;mail.imap.connectiontimeout&quot;, 30000);</span>
<span class="nc" id="L174">            properties.put(&quot;mail.imap.timeout&quot;, 30000);</span>
<span class="nc" id="L175">            properties.put(&quot;mail.imap.writetimeout&quot;, 30000);</span>
        }

<span class="nc" id="L178">        Session session = Session.getInstance(properties);</span>

<span class="nc" id="L180">        Store store = session.getStore(&quot;imap&quot;);</span>
<span class="nc" id="L181">        store.connect(ConfigUtil.getConfigStringValue(ConfigType.INBOX_USERNAME),</span>
<span class="nc" id="L182">                ConfigUtil.getConfigStringValue(ConfigType.INBOX_PASSWORD));</span>

<span class="nc" id="L184">        Folder inbox = store.getFolder(ConfigUtil.getConfigStringValue(ConfigType.INBOX_FOLDER));</span>
<span class="nc" id="L185">        inbox.open(Folder.READ_WRITE);</span>
<span class="nc" id="L186">        return inbox;</span>
    }

    /**
     * Import an email.
     *
     * @param message Message
     * @throws Exception e
     */
    private void importMessage(Message message, Map&lt;String, String&gt; tags) throws Exception {
<span class="nc" id="L196">        log.info(&quot;Importing message: &quot; + message.getSubject());</span>

        // Parse the mail
<span class="nc" id="L199">        EmailUtil.MailContent mailContent = new EmailUtil.MailContent();</span>
<span class="nc" id="L200">        mailContent.setSubject(message.getSubject());</span>
<span class="nc" id="L201">        mailContent.setDate(message.getSentDate());</span>
<span class="nc" id="L202">        EmailUtil.parseMailContent(message, mailContent);</span>

        // Create the document
<span class="nc" id="L205">        Document document = new Document();</span>
<span class="nc" id="L206">        String subject = mailContent.getSubject();</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">        if (subject == null) {</span>
<span class="nc" id="L208">            subject = &quot;Imported email from EML file&quot;;</span>
        }

<span class="nc" id="L211">        HashSet&lt;String&gt; tagsFound = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">        if (tags != null) {</span>
<span class="nc" id="L213">            Pattern pattern = Pattern.compile(&quot;#([^\\s:#]+)&quot;);</span>
<span class="nc" id="L214">            Matcher matcher = pattern.matcher(subject);</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">            while (matcher.find()) {</span>
<span class="nc bnc" id="L216" title="All 4 branches missed.">                if (tags.containsKey(matcher.group(1)) &amp;&amp; tags.get(matcher.group(1)) != null) {</span>
<span class="nc" id="L217">                    tagsFound.add(tags.get(matcher.group(1)));</span>
<span class="nc" id="L218">                    subject = subject.replaceFirst(&quot;#&quot; + matcher.group(1), &quot;&quot;);</span>
                }
            }
<span class="nc" id="L221">            log.debug(&quot;Tags found: &quot; + String.join(&quot;, &quot;, tagsFound));</span>
<span class="nc" id="L222">            subject = subject.trim().replaceAll(&quot; +&quot;, &quot; &quot;);</span>
        }

<span class="nc" id="L225">        document.setUserId(&quot;admin&quot;);</span>
<span class="nc" id="L226">        document.setTitle(StringUtils.abbreviate(subject, 100));</span>
<span class="nc" id="L227">        document.setDescription(StringUtils.abbreviate(mailContent.getMessage(), 4000));</span>
<span class="nc" id="L228">        document.setSubject(StringUtils.abbreviate(mailContent.getSubject(), 500));</span>
<span class="nc" id="L229">        document.setFormat(&quot;EML&quot;);</span>
<span class="nc" id="L230">        document.setSource(&quot;Inbox&quot;);</span>
<span class="nc" id="L231">        document.setLanguage(ConfigUtil.getConfigStringValue(ConfigType.DEFAULT_LANGUAGE));</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">        if (mailContent.getDate() == null) {</span>
<span class="nc" id="L233">            document.setCreateDate(new Date());</span>
        } else {
<span class="nc" id="L235">            document.setCreateDate(mailContent.getDate());</span>
        }

        // Save the document, create the base ACLs
<span class="nc" id="L239">        DocumentUtil.createDocument(document, &quot;admin&quot;);</span>

        // Add the tag
<span class="nc" id="L242">        String tagId = ConfigUtil.getConfigStringValue(ConfigType.INBOX_TAG);</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">        if (tagId != null) {</span>
<span class="nc" id="L244">            TagDao tagDao = new TagDao();</span>
<span class="nc" id="L245">            Tag tag = tagDao.getById(tagId);</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">            if (tag != null) {</span>
<span class="nc" id="L247">                tagsFound.add(tagId);</span>
            }
        }

        // Update tags
<span class="nc bnc" id="L252" title="All 2 branches missed.">        if (!tagsFound.isEmpty()) {</span>
<span class="nc" id="L253">            new TagDao().updateTagList(document.getId(), tagsFound);</span>
        }

        // Raise a document created event
<span class="nc" id="L257">        DocumentCreatedAsyncEvent documentCreatedAsyncEvent = new DocumentCreatedAsyncEvent();</span>
<span class="nc" id="L258">        documentCreatedAsyncEvent.setUserId(&quot;admin&quot;);</span>
<span class="nc" id="L259">        documentCreatedAsyncEvent.setDocumentId(document.getId());</span>
<span class="nc" id="L260">        ThreadLocalContext.get().addAsyncEvent(documentCreatedAsyncEvent);</span>

        // Add files to the document
<span class="nc bnc" id="L263" title="All 2 branches missed.">        for (EmailUtil.FileContent fileContent : mailContent.getFileContentList()) {</span>
<span class="nc" id="L264">            FileUtil.createFile(fileContent.getName(), null, fileContent.getFile(), fileContent.getSize(),</span>
<span class="nc" id="L265">                    document.getLanguage(), &quot;admin&quot;, document.getId());</span>
<span class="nc" id="L266">        }</span>

<span class="nc bnc" id="L268" title="All 2 branches missed.">        if (ConfigUtil.getConfigBooleanValue(ConfigType.INBOX_DELETE_IMPORTED)) {</span>
<span class="nc" id="L269">            message.setFlag(Flags.Flag.DELETED, true);</span>
        }
<span class="nc" id="L271">    }</span>

    /**
     * Fetches a HashMap with all tag names as keys and their respective ids as values.
     *
     * @return Map with all tags or null if not enabled
     */
    private Map&lt;String, String&gt; getAllTags() {
<span class="nc bnc" id="L279" title="All 2 branches missed.">        if (!ConfigUtil.getConfigBooleanValue(ConfigType.INBOX_AUTOMATIC_TAGS)) {</span>
<span class="nc" id="L280">            return null;</span>
        }
<span class="nc" id="L282">        TagDao tagDao = new TagDao();</span>
<span class="nc" id="L283">        List&lt;TagDto&gt; tags = tagDao.findByCriteria(new TagCriteria().setTargetIdList(null), new SortCriteria(1, true));</span>

<span class="nc" id="L285">        Map&lt;String, String&gt; tagsNameToId = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">        for (TagDto tagDto : tags) {</span>
<span class="nc" id="L287">            tagsNameToId.put(tagDto.getName(), tagDto.getId());</span>
<span class="nc" id="L288">        }</span>
<span class="nc" id="L289">        return tagsNameToId;</span>
    }

    public Date getLastSyncDate() {
<span class="nc" id="L293">        return lastSyncDate;</span>
    }

    public int getLastSyncMessageCount() {
<span class="nc" id="L297">        return lastSyncMessageCount;</span>
    }

    public String getLastSyncError() {
<span class="nc" id="L301">        return lastSyncError;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>